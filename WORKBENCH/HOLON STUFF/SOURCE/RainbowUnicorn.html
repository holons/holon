<html>
  <head>
<!--:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    DEPENDENCIES - IMPORT MODULES
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-->
    <script>
      function loadScript(src) {
        var el = document.createElement('script');
        el.setAttribute('src', src);
        // el.setAttribute('data-module', name);
        el.async = false;
        document.body.appendChild(el);
      }
       
      // [
      //   'jquery.js',
      //   'main.js',
      // ].forEach(loadScript);
    </script>

    <script src="RainbowUnicorn.js"></script> <!-- BUNDLE.JS (webpack or browserify) -->

    <script>
      var DEPENDENCIES = {};
      // MODULES
      DEPENDENCIES.TemplateBuilder  = {};
      DEPENDENCIES.DynaWrapper      = {};
      DEPENDENCIES.Complexform      = {};
      var DEPs = DEPENDENCIES;
    /*:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
      IMPORT MODULE: TemplateBuilder
    :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::*/
      DEPENDENCIES.TemplateBuilder.getTemplate = function (url) {
        var
          regex     = /.*\/?(components\/.*)\.html/,
          name      = (function getTemplateName () {
            try { return url.match(regex)[1]; }
            catch (error) { throw new Error('Cannot find template: ' + url); }
          })(),
          query     = '[data-template*="'+name+'"]',
          TPLs      = document.querySelectorAll('#TEMPLATES')[0],
          tpl       = TPLs.querySelectorAll(query)
        ;
        if (tpl && tpl.length === 1) {
          return tpl[0].cloneNode(true);
        } else {
          throw new Error('Template Error: '+'"'+query+'"');
        }
      }
      DEPENDENCIES.TemplateBuilder.insertTemplate = function (containerQuery, templateClone) {
        document.querySelectorAll(containerQuery)[0].appendChild(templateClone);
      }
    </script>



    <script type="text/javascript" src='../DEPS/Request/Request.js'></script>
    <script type="text/javascript" src='../DEPS/HTML2DOM/HTML2DOM.js'></script>
<!--:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    DEPENDENCIES - IMPORT COMPONENTS
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-->
    <!-- TEMPLATES -->
    <link id='Complexform' type='text/html' href='../DEPS/Complexform/Complexform.html'>
    <link id='DynaWrapper' type='text/html' href='../DEPS/DynaWrapper/DynaWrapper.html'>
    <!-- SCRIPTS / MODULES -->

    <!-- STYLES: @TODO - import stylus file and client side compile -->

<!--:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    DEPENDENCIES - VENDOR MODULES
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-->
    <script src='../bower_components/jquery/dist/jquery.min.js'></script>
    <script src='../bower_components/dynatable/jquery.dynatable.js'></script>
<!--:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    SPECIFICATION - "RainbowUnicorn"
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-->
    <script src='../SPECIFICATION/dataformat.js'></script>
<!--:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    DEFINE COMPONENT - "RainbowUnicorn"
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-->
    <link rel='stylesheet' type='text/css' href='./RainbowUnicorn.css'>
  </head>
  <body>
    <div id='RainbowUnicorn'></div>
<!--:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    TEMPLATES CONTAINER
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-->
    <div id='TEMPLATES' style='display: none; !important'></div>


<!--:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    MODULES
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-->
    <script>
    // IMPORT - DynaWrapper, Complexform
    </script>

<!--:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    INITIALIZE
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-->
    <script>
      /////////////////////////////////////////////////////////////////////////
      // LOAD IMPORTS
      ajax(
        document.querySelector('#Complexform').getAttribute('href'),
        function onResponse (html) {
          document.querySelector('#TEMPLATES').appendChild(HTML2DOM(html));
          START();
        }
      );
      ajax(
        document.querySelector('#DynaWrapper').getAttribute('href'),
        function onResponse (html) {
          document.querySelector('#TEMPLATES').appendChild(HTML2DOM(html));
          START();
        }
      );


      function START() {
        /////////////////////////////////////////////////////////////////////////
        var
          //// CREATE DUMMY DATA
          dummyDataOriginal   = GENERATOR.dummyData(12, 'simple'),
          //// TRANSFORM DATA
          dummyData           = (function transform(data) {
            for(item in data) {
              data[item].fullname = data[item].firstname + ' ' + data[item].lastname;
            }
            return data;
          })(dummyDataOriginal),
          //// CREATE SCHEMA
          dummySchema         = (function getSchema (sample, schema) {
            for(key in sample) {
              if (sample.hasOwnProperty(key)) {
                schema.push(key);
              }
            }
            return schema;
          })(dummyData[0], [])
        ;
        /////////////////////////////////////////////////////////////////////////


        // BUILD APP
        window.IKUSEI = (function buildApp (APP) {


          //:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
          // INITIALIZE COMPONENTS - DYNAWRAPPER
          APP.DYNAWRAPPER = (function init_dynatable (CONTAINER) {
            var name = 'v0.0.1/api/components/DynaWrapper.html';
            // INSTANTIATE TEMPLATE
            var dynatable = DEPs.TemplateBuilder.getTemplate(name);
            // SET DUMMY DATA (instead of backend rendered version)
            dynatable.dataset.json    = JSON.stringify(dummyData);
            dynatable.dataset.schema  = JSON.stringify((function filter() {
              var schema = dummySchema;
              // return ['', 'fullname', 'phone', 'email', 'company_name', 'action']; // @TODO: with selectbox
              return ['fullname', 'phone', 'email', 'company_name', 'action'];
            })());
            // PREPROCESS - CONFIGURE SCHEMA
            DEPs.DynaWrapper.setSchema(dynatable);
            // INSERT TEMPLATE
            // @TODO: Realize the API below, thus: reduce COMPONENT API
            // DEPs.TemplateBuilder.insertTemplate(CONTAINER, TEMPLATE, DATA, SCHEMA);
            DEPs.TemplateBuilder.insertTemplate(CONTAINER, dynatable);
            // INIT DYNATABLE
            DEPs.DynaWrapper.initTable(dynatable);
            // PUBLISH ENTITY INTERFACE
            return dynatable;
          })('#RainbowUnicorn');


          //:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
          // INITIALIZE COMPONENTS - COMPLEXFORM
          APP.COMPLEXFORM = (function init_complexform (CONTAINER) {
            var name = 'v0.0.1/api/components/Complexform.html';
            // INSTANTIATE TEMPLATE
            var complexform = DEPs.TemplateBuilder.getTemplate(name);
            // SET DUMMY DATA (instead of backend rendered version)
            complexform.dataset.json    = JSON.stringify(dummyData[0]);
            complexform.dataset.schema  = JSON.stringify((function filter() {
              var schema = dummySchema;
              return schema;
              // return ['', 'fullname', 'phone', 'email', 'company_name', 'action'];
            })());
            // INSERT TEMPLATE
            DEPs.TemplateBuilder.insertTemplate(CONTAINER, complexform);
            // INIT COMPLEXFORM
            DEPs.Complexform.init(complexform);
            // PUBLISH ENTITY INTERFACE
            return complexform;
          })('#RainbowUnicorn');


          //:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
          (function wireUp_COMPLEXFORM() { // (map 'component events' to 'component apis')
            APP.DYNAWRAPPER.addEventListener('ADD', function (EVENT) {
              APP.COMPLEXFORM.className = APP.COMPLEXFORM.className.replace(
                'STATE=hidden',
                'STATE=default'
              );
              APP.COMPLEXFORM.API.INTERFACE['USER_ADD'](EVENT.detail.data.id);
            });

            APP.DYNAWRAPPER.addEventListener('SET', function (EVENT) {
              APP.COMPLEXFORM.className = APP.COMPLEXFORM.className.replace(
                'STATE=hidden',
                'STATE=default'
              );
              APP.COMPLEXFORM.API.INTERFACE['USER_SET'](EVENT.detail.data);
            });
          })();


          //:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
          (function wireUp_DYNAWRAPPER() { // (map 'component events' to 'component apis')
            APP.COMPLEXFORM.addEventListener('CANCEL', function () {
              // Should maybe happen "complexform internally" - @TODO: HOOK CANDIDATE
              APP.COMPLEXFORM.className = APP.COMPLEXFORM.className.replace(
                'STATE=default',
                'STATE=hidden'
              );
            });

            APP.COMPLEXFORM.addEventListener('SAVE', function (EVENT) {
              if (EVENT.detail.data.id) {
                APP.DYNAWRAPPER.API.INTERFACE['set'](EVENT.detail.data.id, EVENT.detail.data);
              } else {
                APP.DYNAWRAPPER.API.INTERFACE['add'](EVENT.detail.data);
              }
            });
          })();

          //:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
          // DEPLOY APP
          return APP;
        })({});
      }
    </script>
  </body>

</html>
