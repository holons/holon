<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>DOM Mutation Events + DOM Mutation Observers</title>
  </head>
  <body>

    <div
      id='widget_Dummy'
      data-url='http://localhost:3000/api/v0.0.1/data/helloworld/'
      data-json='{"a":"b","c":"d"}'
      data-test='m00'
      data-param-test=''
      data-param-foo=''
      data-param-goo=''
      data-return=''
    >
      Hello World
    </div>
    <button onclick="changeMoo()">Change Hello World m00 Attribute</button>

    <xmp>
    <div
      id='widget_Dummy'
      data-container='[class=~"--widget_Dummy"]'
      data-url='http://localhost:3000/api/v0.0.1/data/helloworld/'
      data-json='{"a":"b","c":"d"}'
      data-test='m00'
      data-param-test=''
      data-param-foo=''
      data-param-goo=''
      data-return=''
    >
      Hello World
    </div>
    <button onclick="changeMoo()">Change Hello World m00 Attribute</button>
    </xmp>

    <script>
      /*:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::*\
      MUTATION OBSERVERS - (W3C DOM4)

      // Notifications are similar to Mutation Observers.
      // They happen at the end of the micro-task.
      // In the browser context, this is almost always going to be at the end of the current event handler.
      // The timing is nice because generally one unit of work is finished and now observers get to do their work.
      // Itâ€™s a nice turn-based processing model.

      // BEST: Mutation Observer
      // Mutation Events - for older browsers
      // Property Change Events for IE < IE 11

      CALLBACK PARAMETERS:
        1. List of MutationRecords (elements represent mutations of observed element in order of occurence)
        2. Reference to MutationObserver invoking the Callback

        MutationRecord property Description
          - type    // of logged record [Possible values: attributes, characterData, childList]
          - target  // element for which the mutation was logged
          - addedNodes // array of nodes that were added as part of mutation [context: childList]
          - removedNodes // array of nodes that were removed as part of mutation [context: childList]
          - previousSibling // of added/removed Node [context: childList]
          - nextSibling     // of added/removed Node [context: childList]
          - attributeName   // of changed/added/removed attribute [context: attribute]
          - attributeNamespace // of changed/added/removed attribute [context: attribute]
          - oldValue // previous value of attribute or characterData
      :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::*/
      var observe = (function env (MutationObserver, Adapter) {
        var config = {
          attributes            : true,
          childList             : false,  // direct children
          characterData         : true,
          attributeOldValue     : true,
          characterDataOldValue : true,
          subtree               : false   // decendants
          // attributeFilter       : ['data-*']
        };
        // Object.observe(), part of a future ECMAScript standard,
        // is a method for asynchronously observing changes to JavaScript objects
        // ...without the need for a separate library
        return function observe (target, reaction) {
          return new MutationObserver(Adapter(reaction)).observe(target, config);
        };
        // observer receives time-ordered sequence of ChangeRecords (describe changeset of observed objectsset
          // If you don't save a reference to it, the mutation observer instance will be preserved in-memory
          // by the web platform as long as it is observing at least one element.
          // you can still reference it from the observer's callback (it will be the this object in the callback's scope, as well as the 2nd parameter to the callback function).
      })(
        // Web Components - Polyfills (for x-tag & polymer) for older browsers
        // maybe POLYFILL ?? => https://code.google.com/p/mutation-summary/source/checkout
        // Short per function polyfills => https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind#Compatibility
        window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver || 'POLYFILL',
        function Adapter (react) {
          var interface = /^data-.*$/;
          return function adapt (MutationRecords, Observer) {
            console.log('UPDATE');
            var attribute, isInterface, currentVal, oldVal, hasChanged;
            for (var i=0; i<MutationRecords.length; i++) {
              attribute   = MutationRecords[i].attributeName;
              isInterface = interface.test(attribute);
              if (isInterface) {
                currentVal  = MutationRecords[i].target.getAttribute(attribute);
                oldVal      = MutationRecords[i].oldValue;
                hasChanged  = (currentVal !== oldVal);
                if (hasChanged) {
                  react.call({/*UNDEFINED*/},
                    attribute,
                    currentVal,
                    oldVal,
                    MutationRecords[i].target.dataset);
                }
              }
            }
          };
        }
        // PREPARE
        // https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver
        // http://www.html5rocks.com/en/tutorials/es7/observe/
      );
      ///////////////////////////////////////////////////////////////////////////
      // EXAMPLES

      console.log('===============================================');

      var target = document.querySelector('#widget_Dummy');

      function myReaction (attribute, newValue, oldValue, model) {
        console.log(attribute);
        console.log(newValue);
        console.log(oldValue);
        console.log(model);
        target.dataset.test = 'g0000gl3';
      }



      observe(target, myReaction);

      console.log('CHANGE: changeMoo()');
      console.log('disconnect: observer.disconnect()');
      // Object.unobserve(todoModel, observer2);
      // var opt_acceptList = ['delete'];
      // Object.observe(obj, callback, opt_acceptList);
      function changeMoo () {
        var val = target.dataset.test;
        target.dataset.test = val === 'f00' ? 'm00' : 'f00';
        target.dataset.test2 = val === 'f00' ? 'm00' : 'f00';
      }
      // later, you can stop observing
      // x.disconnect();
      console.log('===============================================');


              // ///// ADVANCED
              // // Define a simple model
              // var model = {
              //     a: {}
              // };

              // // And a separate variable we'll be using for our model's 
              // // getter in just a moment
              // var _b = 2;

              // // Define a new property 'b' under 'a' with a custom
              // // getter and setter

              // Object.defineProperty(model.a, 'b', {
              //     get: function () {
              //         return _b;
              //     },
              //     set: function (b) {

              //         // Whenever 'b' is set on the model
              //         // notify the world about a specific type
              //         // of change being made. This gives you a huge
              //         // amount of control over notifications
              //         Object.getNotifier(this).notify({
              //             type: 'update',
              //             name: 'b',
              //             oldValue: _b
              //         });

              //         // Let's also log out the value anytime it gets
              //         // set for kicks
              //         console.log('set', b);

              //         _b = b;
              //     }
              // });

              // // Set up our observer
              // function observer(changes) {
              //     changes.forEach(function (change, i) {
              //         console.log(change);
              //     })
              // }

              // // Begin observing model.a for changes
              // Object.observe(model.a, observer);

              // var ChangeRecord = {
              //   type: '',
              //   object: '',
              //   name: '',
              //   oldValue: ''
              // };
              // // http://www.html5rocks.com/en/tutorials/es7/observe/



              // //////////////////// ADVANCED 2

              // function Circle(r) {
              //   var radius = r;
               
              //   var notifier = Object.getNotifier(this);
              //   function notifyAreaAndRadius(radius) {
              //     notifier.notify({
              //       type: 'update',
              //       name: 'radius',
              //       oldValue: radius
              //     })
              //     notifier.notify({
              //       type: 'update',
              //       name: 'area',
              //       oldValue: Math.pow(radius * Math.PI, 2)
              //     });
              //   }
               
              //   Object.defineProperty(this, 'radius', {
              //     get: function() {
              //       return radius;
              //     },
              //     set: function(r) {
              //       if (radius === r)
              //         return;
              //       notifyAreaAndRadius(radius);
              //       radius = r;
              //     }
              //   });
               
              //   Object.defineProperty(this, 'area', {
              //     get: function() {
              //       return Math.pow(radius, 2) * Math.PI;
              //     },
              //     set: function(a) {
              //       r = Math.sqrt(a)/Math.PI;
              //       notifyAreaAndRadius(radius);
              //       radius = r;
              //     }
              //   });
              // }
               
              // function observer(changes){
              //   changes.forEach(function(change, i){
              //     console.log(change);
              //   })
              // }




              //     // Let's say we have a model with data
              //     var model = {};
              //     // Which we then observe
              //     Object.observe(model, function(changes){
              //         // This asynchronous callback runs
              //         changes.forEach(function(change) {
              //             // Letting us know what changed
              //             console.log(change.type, change.name, change.oldValue);
              //         });
              //     });

    </script>

  </body>
</html>
